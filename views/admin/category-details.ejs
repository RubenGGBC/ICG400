<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title><%= category.title %> - Resultados Detallados</title>
    <link rel="stylesheet" href="/css/style.css">
</head>
<body>
    <%- include('../partials/navbar', { user: user }) %>

    <main class="main-content">
        <div class="container">
            <div class="detailed-results-content" style="position: relative; margin-top: 2rem;">
                <div class="detailed-results-header">
                    <a href="/admin/results" class="modal-close-btn" title="Volver">‚úï</a>
                    <h2>Resultados Detallados</h2>
                    <p><%= category.title %></p>
                </div>

                <%- include('../partials/message') %>

                <table class="results-table">
                    <thead>
                        <tr>
                            <th>Pos.</th>
                            <th>Nominado</th>
                            <th style="text-align: center;">Votos</th>
                            <th style="text-align: right; padding-right: 2rem;">Porcentaje</th>
                        </tr>
                    </thead>
                    <tbody>
                        <%
                            const sortedOptions = category.options.sort((a, b) => b.votes - a.votes);
                        %>
                        <% sortedOptions.forEach((option, index) => {
                            const percentage = totalVotes > 0 ? ((option.votes / totalVotes) * 100).toFixed(2) : '0.00';
                        %>
                            <tr>
                                <td class="position-cell">
                                    <% if (index === 0 && option.votes > 0) { %>
                                        <div class="position-trophy">üèÜ</div>
                                        <div style="font-size: 0.8rem; color: var(--text-secondary);">1</div>
                                    <% } else { %>
                                        <div class="position-number"><%= index + 1 %></div>
                                    <% } %>
                                </td>
                                <td class="nominee-cell"><%= option.text %></td>
                                <td class="votes-cell">
                                    <span class="votes-badge"><%= option.votes %></span>
                                </td>
                                <td class="percentage-cell"><%= percentage %>%</td>
                            </tr>
                        <% }); %>
                    </tbody>
                </table>

                <div style="padding: 2rem; text-align: center; border-top: 1px solid var(--border-color);">
                    <div style="display: flex; justify-content: space-around; flex-wrap: wrap; gap: 2rem;">
                        <div>
                            <strong style="color: var(--neon-cyan);">Total de Votos:</strong>
                            <div style="font-size: 2rem; font-weight: bold; color: var(--text-primary);"><%= totalVotes %></div>
                        </div>
                        <div>
                            <strong style="color: var(--neon-cyan);">Votantes √önicos:</strong>
                            <div style="font-size: 2rem; font-weight: bold; color: var(--text-primary);"><%= new Set(category.options.flatMap(opt => opt.voters.map(v => v._id || v))).size %></div>
                        </div>
                        <div>
                            <strong style="color: var(--neon-cyan);">Estado:</strong>
                            <div style="font-size: 1.2rem; margin-top: 0.5rem;">
                                <% if (category.isActive) { %>
                                    <span class="badge badge-success">Activa</span>
                                <% } else { %>
                                    <span class="badge badge-secondary">Inactiva</span>
                                <% } %>
                            </div>
                        </div>
                    </div>
                </div>

                <% if (votes && votes.length > 0) { %>
                    <details style="padding: 2rem; border-top: 1px solid var(--border-color);">
                        <summary style="cursor: pointer; font-size: 1.2rem; font-weight: 600; margin-bottom: 1rem;">
                            Ver Historial de Votos (<%= votes.length %>)
                        </summary>
                        <div style="max-height: 400px; overflow-y: auto;">
                            <% votes.slice(0, 50).forEach((vote, index) => { %>
                                <div style="padding: 0.75rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <strong><%= vote.user.username %></strong>
                                        <small style="color: var(--text-secondary);"> (<%= vote.user.email %>)</small>
                                    </div>
                                    <div>
                                        <span style="color: var(--neon-cyan); margin-right: 1rem;">Opci√≥n: <%= vote.option %></span>
                                        <small style="color: var(--text-secondary);">
                                            <%= new Date(vote.votedAt).toLocaleString('es-ES', {
                                                day: '2-digit',
                                                month: 'short',
                                                year: 'numeric',
                                                hour: '2-digit',
                                                minute: '2-digit'
                                            }) %>
                                        </small>
                                    </div>
                                </div>
                            <% }); %>
                        </div>
                    </details>
                <% } %>

                <div style="padding: 2rem; text-align: center;">
                    <a href="/admin/categories/<%= category._id %>/edit" class="btn btn-secondary" style="margin-right: 1rem;">
                        Editar Categor√≠a
                    </a>
                    <a href="/admin/results" class="btn btn-primary">
                        Volver a Revelaci√≥n
                    </a>
                </div>
            </div>
        </div>
    </main>

    <footer class="footer">
        <p>&copy; 2026 ICG400 Sistema de Votaci√≥n</p>
    </footer>

    <script src="/js/admin.js"></script>
</body>
</html>
